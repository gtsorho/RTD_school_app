<div class="px-3 flex justify-between gap-4">
  <form
    class="flex w-fit gap-4 border-t-8 py-3 px-2 border-red-700 align-bottom bg-white rounded-b text-left overflow-hidden shadow-xl transform transition-all sm:mb-8 sm:mt-2 sm:align-middle"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modal-headline"
  >
    <div class="md:col-span-2">
      <label for="class" class="text-gray-600 ps-2">Class</label>
      <select
        id="class"
        name="class"
        [(ngModel)]="selectedClass"
        (change)="calculateFinals()"
        class="h-8 border text-gray-700 uppercase focus:border-red-700 focus:ring-red-700 focus:outline-none mt-1 rounded px-4 w-full bg-gray-50"
      >
        <option *ngFor="let class of classes" [value]="class.id">
          {{ class.name }}
        </option>
      </select>
    </div>
  </form>

  <div class="px-5 py-3">
    <p class="text-2xl font-bold text-gray-700">Class Summary</p>
    <p class="text-sm text-gray-500">
      This table displays the students in the selected class along with their
      assessment scores and efforts for the current term/year. You can update
      scores and efforts directly in the table. Click on

      <i
        class="bi text-base bi-graph-up-arrow bg-red-700 py-1 px-1.5 hover:bg-red-800 text-white shadow-md rounded-full"
      ></i>
      to view a visual representation of the class performance
    </p>
  </div>
</div>

<div
  class="overflow-auto max-h-[70vh] rounded shadow-lg border border-gray-200 mx-3"
>
  <table class="min-w-full table-fixed divide-y divide-gray-200 font-mono">
    <thead class="bg-gray-50 sticky top-0 z-10 ">
      <tr class="">
        <th
          rowspan="2"
          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase  tracking-wider bg-gray-100 "
        >
          #
        </th>
        <th
          rowspan="2"
          class="px-6 py-3 text-left text-xs font-medium  text-gray-500 uppercase tracking-wider bg-gray-100 sticky left-[0px] z-20"
        >
          Student Name
        </th>
        <th
          rowspan="2"
          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-200"
        >
          Term/Year
        </th>
        <th
          rowspan="2"
          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-100"
        >
          Class
        </th>

        <th
          *ngFor="let subject of subjects; let i = index"
          colspan="2"
          class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-200 w-48"
        >
          {{ subject.name }}
        </th>

        <th
          rowspan="2"
          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-100"
        >
          Min
        </th>
                <th
          rowspan="2"
          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-100"
        >
          Avg
        </th>
                <th
          rowspan="2"
          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-100"
        >
          Max
        </th>
      </tr>

      <!-- Second row: Sub-headers for each assessment -->
      <!-- <tr>
        <ng-container *ngFor="let score of students[0]?.scores">
          <th
            class="text-left text-xs font-medium text-gray-500 bg-blue-100 px-3 py-2"
          >
            Score
          </th>
          <th
            class="text-left text-xs font-medium text-gray-500 bg-yellow-100 px-3 py-2"
          >
            Effort
          </th>
        </ng-container>
      </tr> -->
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      <tr
        *ngFor="let student of students; let i = index"
        class="group hover:cursor-pointer "
      >
        <!-- Index -->
        <td
          class=" px-6 whitespace-nowrap text-sm font-medium capitalize text-gray-900 bg-transparent group-hover:bg-red-100"
        >
          {{ i + 1 }}
        </td>

        <!-- Student Name -->
        <td
          class="sticky left-0 px-6  bg-white whitespace-nowrap text-sm font-medium capitalize text-gray-900  group-hover:bg-red-100 "
        >
          {{ student.name }}
        </td>

        <!-- Term / Year -->
        <td
          class="px-6 whitespace-nowrap text-sm text-gray-500 bg-gray-100 group-hover:bg-red-100"
        >
          {{ student.finalAssessments[0]?.academicYear?.name }}
          <p class="text-xs text-gray-400">
            {{ student.finalAssessments[0]?.term?.name }}
          </p>
        </td>

        <!-- Class -->
        <td
          class="px-6 whitespace-nowrap text-sm text-gray-500 bg-white group-hover:bg-red-100"
        >
          {{ student.class?.name }}
        </td>

        <ng-container *ngFor="let subject of subjects">
          <ng-container
            *ngIf="
              student.finalScoreMap.get(subject.id) as finalScore;
              else noScore
            "
          >
            <td
              class="px-6 whitespace-nowrap text-sm text-gray-700 bg-blue-100/80 group-hover:bg-red-100"
            >
              {{ finalScore.total_score }}
             </td>
            <td class="px-6 text-sm bg-yellow-100/80 group-hover:bg-red-100">
              {{ finalScore.total_effort }}
            </td>
          </ng-container>

          <ng-template #noScore>
            <td
              class="px-6 whitespace-nowrap text-sm text-gray-400 bg-gray-100"
            >
              —
            </td>
            <td
              class="px-6 whitespace-nowrap text-sm text-gray-400 bg-gray-100"
            >
              —
            </td>
          </ng-template>
        </ng-container>

        <td
          class="px-6 whitespace-nowrap text-sm text-gray-900 bg-white font-bold group-hover:bg-red-100"
        >
          {{ student.minScore }}
        </td>
                <td
          class="px-6 whitespace-nowrap text-sm text-gray-900 bg-white font-bold group-hover:bg-red-100"
        >
          {{ student.avgScore }}
        </td>
                <td
          class="px-6 whitespace-nowrap text-sm text-gray-900 bg-white font-bold group-hover:bg-red-100"
        >
          {{ student.maxScore }}
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div
  *ngIf="loading"
  class="z-50 absolute inset-0 flex items-center justify-center bg-gray-500 bg-opacity-70"
>
  <app-spinner color="spinner-white" size="spinner-sm"></app-spinner>
</div>

<!-- Modal and Overlay -->
<!-- <div *ngIf="showModal" class="fixed inset-0 z-50 flex items-center justify-center">
  <div
    class="absolute inset-0 bg-black bg-opacity-50"
    (click)="closeModal()"
    aria-hidden="true"
  ></div>

  <div
    class="relative bg-red-50 p-6 w-2/3 rounded shadow-lg z-60"
    (click)="$event.stopPropagation()"
  >
    <apx-chart
      [series]="chartOptions.series!"
      [chart]="chartOptions.chart!"
      [xaxis]="chartOptions.xaxis!"
      [title]="chartOptions.title!"
      [dataLabels]="chartOptions.dataLabels!"
      [legend]="chartOptions.legend!"
      [fill]="chartOptions.fill!"
    ></apx-chart>
  </div>
</div>

<button
  class="fixed bottom-8 right-8 z-50 bg-red-700 hover:bg-red-800 text-white rounded-full px-4 py-3 shadow-lg transition-all flex items-center justify-center hover:scale-110"
  (click)="showModal = !showModal"
  aria-label="Show Chart"
  style="font-size: 2rem;"
>
  <i class="bi text-base bi-graph-up-arrow"></i>
</button> -->
